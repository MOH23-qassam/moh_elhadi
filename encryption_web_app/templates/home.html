<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>تشفير وفك التشفير</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };

    window.onload = function () {
      // إعداد الوضع من التخزين المحلي
      if (localStorage.theme === 'dark') {
        document.documentElement.classList.add('dark');
      } else if (localStorage.theme === 'light') {
        document.documentElement.classList.remove('dark');
      }

      // زر تبديل الوضع
      window.toggleTheme = function () {
        document.documentElement.classList.toggle('dark');
        localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
      };
    };

    async function submitForm(event, action) {
      event.preventDefault();
      document.getElementById("loading").style.display = "flex";

      const formData = new FormData();
      formData.append("action", action);
      formData.append("password", document.getElementById("password").value);
      formData.append("file", document.getElementById("file").files[0]);

      try {
        const response = await fetch("/home", {
          method: "POST",
          body: formData
        });

        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = downloadUrl;
        a.download = getFileNameFromHeader(response.headers.get("Content-Disposition"));
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(downloadUrl);
      } catch (err) {
        alert("حدث خطأ أثناء المعالجة.");
        console.error(err);
      } finally {
        document.getElementById("loading").style.display = "none";
        document.getElementById("password").value = "";
        document.getElementById("file").value = "";

      }
    }

    function getFileNameFromHeader(header) {
      if (!header) return "file";
      const match = header.match(/filename="?([^"]+)"?/);
      return match ? match[1] : "file";
    }

    function togglePasswordVisibility(inputId, iconId) {
      const input = document.getElementById(inputId);
      const icon = document.getElementById(iconId);
      if (input.type === "password") {
        input.type = "text";
        icon.textContent = "🙈";
      } else {
        input.type = "password";
        icon.textContent = "👁️";
      }
    }
  </script>
</head>
<body class="bg-gradient-to-br from-gray-900 to-gray-800 text-white min-h-screen font-sans">

  <!-- شاشة تحميل -->
  <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center flex-col">
    <svg class="animate-spin h-10 w-10 text-green-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
    </svg>
    <p class="text-lg font-semibold">جاري المعالجة...</p>
  </div>

  <div class="max-w-xl mx-auto p-6 mt-10 bg-gray-900 rounded-2xl shadow-2xl border border-gray-700">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-extrabold text-green-400">🔐 تشفير وفك تشفير الملفات</h1>
      <button onclick="toggleTheme()" class="text-sm text-gray-400 hover:underline">🌓 تبديل المظهر</button>
    </div>

    <form class="space-y-4">
      <input id="file" type="file" class="w-full p-3 border border-gray-600 rounded-xl bg-gray-800 text-white" required />
      <div class="relative">
        <input id="password" type="password" placeholder="كلمة المرور" class="w-full p-3 border border-gray-600 rounded-xl text-right bg-gray-800 text-white" required />
        <span id="toggle-password" onclick="togglePasswordVisibility('password', 'toggle-password')" class="absolute left-3 top-3 cursor-pointer select-none">👁️</span>
      </div>
      <div class="flex gap-4">
        <button onclick="submitForm(event, 'encrypt')" class="flex-1 bg-blue-700 text-white py-3 rounded-xl hover:bg-blue-800 transition">🔒 تشفير</button>
        <button onclick="submitForm(event, 'decrypt')" class="flex-1 bg-yellow-600 text-white py-3 rounded-xl hover:bg-yellow-700 transition">🔓 فك التشفير</button>
      </div>
    </form>

    <hr class="my-6 border-gray-600" />

    <h2 class="text-xl font-bold text-center text-white mb-4">🔧 تغيير كلمة المرور</h2>
    <form method="POST" class="space-y-3">
      <input type="hidden" name="action" value="change_password" />
      <div class="relative">
        <input type="password" name="old_password" id="old_password" placeholder="كلمة المرور الحالية" class="w-full p-3 border border-gray-600 rounded-xl text-right bg-gray-800 text-white" required />
        <span id="toggle-old-password" onclick="togglePasswordVisibility('old_password', 'toggle-old-password')" class="absolute left-3 top-3 cursor-pointer select-none">👁️</span>
      </div>
      <div class="relative">
        <input type="password" name="new_password" id="new_password" placeholder="كلمة المرور الجديدة" class="w-full p-3 border border-gray-600 rounded-xl text-right bg-gray-800 text-white" required />
        <span id="toggle-new-password" onclick="togglePasswordVisibility('new_password', 'toggle-new-password')" class="absolute left-3 top-3 cursor-pointer select-none">👁️</span>
      </div>
      <button type="submit" class="w-full bg-green-700 text-white py-3 rounded-xl hover:bg-green-800 transition">🔑 تغيير كلمة المرور</button>
    </form>

    <div class="text-center mt-6">
      <a href="/logout" class="text-sm text-gray-400 hover:underline">🚪 تسجيل الخروج</a>
    </div>
  </div>
</body>
</html>

